<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart Advisor TPCN ‚Ä¢ Demo</title>
<style>
  :root{--brand:#0f766e;--soft:#ecfeff}
  body{font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,sans-serif;background:#f8fafc;margin:0}
  .wrap{max-width:780px;margin:24px auto;padding:16px}
  .card{background:white;border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,.06);padding:16px}
  h1{font-size:22px;margin:0 0 4px}
  .sub{color:#64748b;margin:0 0 16px}
  .chat{height:520px;overflow:auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
  .msg{margin:10px 0;max-width:80%;padding:10px 12px;border-radius:12px;white-space:pre-wrap}
  .user{background:var(--soft);border:1px solid #cffafe;margin-left:auto}
  .bot{background:#f1f5f9;border:1px solid #e2e8f0}
  .row{display:flex;gap:8px;margin-top:12px}
  input,button{padding:12px;border-radius:12px;border:1px solid #e5e7eb;font-size:15px}
  button{background:var(--brand);color:white;border:none;cursor:pointer}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .chip{background:#e0f2fe;border:1px solid #bae6fd;color:#0c4a6e;padding:6px 10px;border-radius:999px;cursor:pointer}
  a{color:#0f766e}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Smart Advisor TPCN ü§ñüçÉ</h1>
    <p class="sub">Nh·∫≠p tri·ªáu ch·ª©ng / t√™n s·∫£n ph·∫©m / combo. Demo g·ªçi <code>/ask</code> FastAPI.</p>

    <div class="chips">
      <span class="chip">Kh√°ch b·ªã ƒëau l∆∞ng m·∫•y ng√†y nay</span>
      <span class="chip">G·ª£i √Ω combo cho ƒëau l∆∞ng</span>
      <span class="chip">H∆∞·ªõng d·∫´n d√πng gel gi·∫£m ƒëau l∆∞ng</span>
    </div>

    <div id="chat" class="chat"></div>

    <div class="row">
      <input id="q" placeholder="V√≠ d·ª•: Kh√°ch n√≥i ƒëau l∆∞ng, n√™n d√πng g√¨?" style="flex:1"/>
      <button id="send">G·ª≠i</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="pregnant"> Thai k·ª≥</label>
      <label><input type="checkbox" id="ulcer"> Lo√©t d·∫° d√†y</label>
    </div>
  </div>
  <p style="color:#64748b;margin-top:12px">*Th√¥ng tin tham kh·∫£o theo t√†i li·ªáu n·ªôi b·ªô TPCN; kh√¥ng thay th·∫ø t∆∞ v·∫•n y t·∫ø.</p>
</div>

<script>
/* ===== Backend API =====
   - Dev n·ªôi b·ªô: t·ª± nh·∫≠n localhost
   - Online: ƒë·ªïi URL d∆∞·ªõi ƒë√¢y th√†nh URL backend Render/Railway c·ªßa anh
*/
const API = (location.hostname === "localhost" || location.hostname === "127.0.0.1")
  ? "http://localhost:8000"
  : "https://script.google.com/macros/s/AKfycbyJts3RIVGN5WH5fICTy4lLAs-qHBazygK1FR_mK_Adwy8QCGj594bThi6W-7wCIu-qhw/exec"; // ‚Üê ƒê·ªîI TH√ÄNH URL BACKEND PUBLIC

const chat = document.getElementById('chat');

function add(role, text){
  const div = document.createElement('div');
  div.className = 'msg ' + (role==='user' ? 'user' : 'bot');
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

async function ask(){
  const qEl = document.getElementById('q');
  const q = qEl.value.trim();
  if(!q) return;
  add('user', q);
  qEl.value = '';

  const payload = {
    query: q,
    profile: {
      pregnant: document.getElementById('pregnant').checked,
      ulcer: document.getElementById('ulcer').checked
    }
  };

  try{
    const res = await fetch(`${API}/ask`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    let text = '';
    if(data.type==='symptom'){
      text += `‚Ä¢ Tri·ªáu ch·ª©ng nh·∫≠n di·ªán: "${data.query}"\n`;
      if(data.triage_questions?.length){
        text += `‚Ä¢ C·∫ßn s√†ng l·ªçc: ${data.triage_questions.join(' ‚Ä¢ ')}\n`;
      }
      if(data.red_flags?.length){
        text += `‚Ä¢ D·∫•u hi·ªáu c·∫£nh b√°o: ${data.red_flags.join(', ')}\n`;
      }
    }
    if(data.products?.length){
      text += `\nüîπ S·∫£n ph·∫©m g·ª£i √Ω:\n`;
      data.products.forEach(p=>{
        text += `- ${p.name} (${p.sku}): ${p.benefits?.join(', ') || ''}\n  ‚ûú C√°ch d√πng: ${p.directions}\n  Link: ${p.link}\n`;
      });
    }
    if(data.combos?.length){
      text += `\nüî∏ Combo ph√π h·ª£p:\n`;
      data.combos.forEach(c=>{
        text += `- ${c.name}: g·ªìm ${c.items.map(i=>`${i.sku} x${i.qty}`).join(', ')}\n  ‚ûú Ph√°c ƒë·ªì: ${c.protocol}\n`;
      });
    }
    if(data.protocol){
      text += `\nüìã Ph√°c ƒë·ªì tham kh·∫£o: ${data.protocol}\n`;
    }
    if(data.safety_notes?.length){
      text += `\n‚ö†Ô∏è L∆∞u √Ω: ${data.safety_notes.join(' ')}\n`;
    }
    text += `\n‚ÑπÔ∏è ${data.disclaimer}`;
    add('bot', text);
  }catch(e){
    add('bot', 'L·ªói k·∫øt n·ªëi API. H√£y ki·ªÉm tra server FastAPI v√† gi√° tr·ªã const API.');
  }
}

document.getElementById('send').onclick = ask;
document.getElementById('q').addEventListener('keydown', e=>{ if(e.key==='Enter') ask(); });
document.querySelectorAll('.chip').forEach(c=>c.onclick=()=>{ document.getElementById('q').value=c.textContent; });
add('bot','Ch√†o b·∫°n! H√£y nh·∫≠p tri·ªáu ch·ª©ng (vd: "Kh√°ch b·ªã ƒëau l∆∞ng") ƒë·ªÉ nh·∫≠n g·ª£i √Ω s·∫£n ph·∫©m, combo & ph√°c ƒë·ªì.');
</script>
</body>
</html>
